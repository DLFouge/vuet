{"version":3,"file":"vuet-route.js","sources":["../../../src/util.js","../../../src/vuet-static.js","../../../src/debug.js","../src/index.js"],"sourcesContent":["const util = {\n  isObject (obj) {\n    return !!obj && Object.prototype.toString.call(obj) === '[object Object]'\n  },\n  getArgMerge () {\n    let opt = {}\n    const args = arguments\n    if (typeof args[0] === 'string') {\n      opt[args[0]] = args.length > 1 ? args[1] : args[0]\n    } else if (args[0] && util.isObject(args[0])) {\n      opt = args[0]\n    }\n    return opt\n  },\n  isPromise (obj) {\n    return !!obj && (typeof obj === 'object' || typeof obj === 'function') && typeof obj.then === 'function'\n  }\n}\n\nexport default util\n","import debug from './debug'\nimport util from './util'\n\nexport let _Vue\n\nexport default function (Vuet) {\n  Object.assign(Vuet, {\n    installed: false,\n    options: {\n      rules: {}\n    },\n    install (Vue) {\n      if (this.installed) return this\n      this.installed = true\n      _Vue = Vue\n      Object.defineProperty(Vue.prototype, '$vuet', {\n        get () { return this.$root._vuet }\n      })\n      Vue.mixin({\n        beforeCreate () {\n          if (typeof this.$options.vuet !== 'undefined') {\n            if (this.$options.vuet instanceof Vuet) {\n              this._vuet = this.$options.vuet\n              this._vuet._init(this)\n            }\n          }\n        },\n        destroyed () {\n          if (typeof this.$options.vuet !== 'undefined') {\n            if (this.$options.vuet instanceof Vuet) {\n              this._vuet.destroy(this)\n            }\n          }\n        }\n      })\n      return this\n    },\n    mapModules (opts) {\n      const mixins = Object.keys(opts).map(alias => {\n        const path = opts[alias]\n        return {\n          computed: {\n            [alias]: {\n              get () {\n                debug.assertModule(this.$vuet, path)\n                return this.$vuet.getModule(path)\n              },\n              set (val) {\n                debug.error(`The'${path}'module is not allowed to assign`)\n              }\n            }\n          }\n        }\n      })\n      return {\n        mixins\n      }\n    },\n    mapRules () {\n      const opts = util.getArgMerge.apply(null, arguments)\n      const vueRules = []\n      const addRule = (ruleName, any) => {\n        const rules = Vuet.options.rules[ruleName]\n        if (!util.isObject(rules)) debug.error(`The'${ruleName}'rule does not exist. Please make sure that it executes 'Vuet.rule('${ruleName}', opts)' before all components`)\n        if (typeof any === 'string') {\n          vueRules.push(rules.rule({ path: any }))\n        } else {\n          vueRules.push(rules.rule(any))\n        }\n      }\n      Object.keys(opts).forEach(ruleName => {\n        const any = opts[ruleName]\n        if (Array.isArray(any)) {\n          return any.forEach(item => {\n            addRule(ruleName, item)\n          })\n        }\n        addRule(ruleName, any)\n      })\n      return {\n        mixins: vueRules\n      }\n    },\n    rule () {\n      Vuet.options.rules[arguments[0]] = arguments[1]\n      if (typeof arguments[1].install === 'function') {\n        arguments[1].install(Vuet, _Vue)\n      }\n      return this\n    },\n    callRuleHook (hook, ...arg) {\n      Object.keys(Vuet.options.rules).forEach(k => {\n        if (typeof Vuet.options.rules[k][hook] === 'function') {\n          Vuet.options.rules[k][hook].apply(undefined, arg)\n        }\n      })\n    }\n  })\n}\n","import { _Vue } from './vuet-static'\n\nconst NAME = '__name__'\n\nexport default {\n  error (msg) {\n    throw new Error(`[${NAME}] ${msg}`)\n  },\n  warn (msg) {\n    if (process.env.NODE_ENV !== 'production') {\n      typeof console !== 'undefined' && console.warn(`[${NAME}] ${msg}`)\n    }\n  },\n  assertModule (vuet, path) {\n    if (path in vuet.modules) {\n      return\n    }\n    this.error(`The '${path}' module does not exist`)\n  },\n  assertVue () {\n    if (!_Vue) {\n      this.error('must call Vue.use(Vuet) before creating a store instance')\n    }\n  },\n  assertFetch (vuet, path) {\n    this.assertModule(vuet, path)\n    if (typeof vuet.getModule(path).fetch !== 'function') {\n      this.error(`'${path}' module 'fetch' must be the function type`)\n    }\n  }\n}\n","import debug from '../../../src/debug'\nimport util from '../../../src/util'\n\nconst NAME = '__route__'\n\nfunction isWatch (vuet, path, route) {\n  const vtm = vuet.getModule(path)\n  let watch = ['fullPath']\n  if (vtm.route.watch) {\n    watch = vtm.route.watch\n  }\n  watch = Array.isArray(watch) ? watch : [watch]\n  const oldWatch = vuet[NAME][path] // old\n  vuet[NAME][path] = [] // new\n  watch.forEach(k => {\n    let data = route\n    k.split('.').forEach(chlidKey => {\n      data = data[chlidKey]\n    })\n    vuet[NAME][path].push(JSON.stringify(data))\n  })\n  return oldWatch.join() !== vuet[NAME][path].join()\n}\n\nexport default {\n  init (vuet) {\n    vuet[NAME] = {}\n  },\n  addModule (vuet, path) {\n    vuet[NAME][path] = []\n    if (!util.isObject(vuet.getModule(path).route)) {\n      vuet.getModule(path).route = {}\n    }\n  },\n  rule ({ path }) {\n    return {\n      beforeCreate () {\n        debug.assertFetch(this.$vuet, path)\n        if (!this.$route) {\n          debug.error(`The 'vue-router' module is not installed`)\n        }\n        const vtm = this.$vuet.getModule(path)\n        if (!util.isObject(vtm.state)) {\n          debug.error(`'${path}' module state must be the object type`)\n        }\n        if (isWatch(this.$vuet, path, this.$route)) {\n          vtm.reset()\n          vtm.state.__routeLoaded__ = true\n          return vtm.fetch(vtm)\n        }\n        if (vtm.route.once !== true || !vtm.state.__routeLoaded__) { // default\n          vtm.state.__routeLoaded__ = true\n          return vtm.fetch(vtm)\n        }\n      },\n      watch: {\n        $route: {\n          deep: true,\n          handler (to, from) {\n            const vtm = this.$vuet.getModule(path)\n            if (isWatch(this.$vuet, path, to)) {\n              vtm.reset()\n              vtm.state.__routeLoaded__ = true\n              vtm.fetch(vtm)\n            }\n          }\n        }\n      }\n    }\n  }\n}\n"],"names":["util","obj","Object","prototype","toString","call","opt","args","arguments","length","isObject","then","_Vue","NAME","msg","Error","process","console","warn","vuet","path","modules","error","assertModule","getModule","fetch","isWatch","route","vtm","watch","Array","isArray","oldWatch","forEach","data","split","chlidKey","push","JSON","stringify","join","assertFetch","$vuet","$route","state","reset","__routeLoaded__","once","to","from"],"mappings":"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"}